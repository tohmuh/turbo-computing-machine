<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambola Caller - Pink Called Numbers</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --green-color: #34c759;
            --blue-bar: #007aff;
            --pink-button: #ff2d55;
            --wood-bg: #4a3728;
            --dark-glossy: #1c1c1e;
            --orange-color: #ff9500;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--wood-bg);
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            margin: 0;
            padding: 20px 0;
            user-select: none;
        }

        .app-container {
            width: 100%;
            max-width: 400px;
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .dialog-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .dialog-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .dialog-box {
            background: linear-gradient(to bottom, #007aff, #005bb5);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            color: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .dialog-overlay.visible .dialog-box {
            transform: scale(1);
        }
        .dialog-box h2 {
            margin: 0;
            font-size: 1.5em;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            font-weight: 600;
        }
        .dialog-buttons {
            margin-top: 25px;
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        .dialog-btn {
            border: none;
            padding: 12px 35px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            cursor: pointer;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .dialog-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        #dialog-yes {
            background: linear-gradient(to bottom, #ff5073, #e6002e);
            border: 2px solid #ff8fab;
        }
        #dialog-no {
            background: linear-gradient(to bottom, #69d130, #44a020);
            border: 2px solid #8efb5a;
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, #4da7ff, #007aff);
            padding: 8px 15px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 1px solid #7dc0ff;
        }
        .icon-btn {
            font-size: 28px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        #restartBtn {
            font-size: 16px;
            font-weight: bold;
            color: white;
            background: linear-gradient(to bottom, #ff5e7d, var(--pink-button));
            border: 1px solid #ff8fab;
            border-radius: 20px;
            padding: 10px 20px;
            cursor: pointer;
            box-shadow: inset 0 1px 1px rgba(255,255,255,0.4), 0 2px 5px rgba(0,0,0,0.3);
            text-shadow: 0 1px 1px rgba(0,0,0,0.4);
        }
        #restartBtn:active {
            transform: scale(0.97);
            background: var(--pink-button);
        }

        .display-area {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 25px 0;
        }
        .token-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .token-box {
            font-family: Arial, Helvetica, sans-serif;
            font-weight: bold;
            background: var(--dark-glossy);
            color: white;
            border-radius: 15px;
            border: 3px solid #333;
            box-shadow: inset 0 0 10px #000, 0 5px 10px rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #prevTokenBox {
            width: 70px;
            height: 70px;
            font-size: 40px;
        }
        #currentTokenBox {
            width: 150px;
            height: 150px;
            font-size: 100px;
        }
        .token-label {
            color: #eee;
            font-weight: 500;
            font-family: 'Orbitron', sans-serif;
        }

        #playBtn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid #f0f0f0;
            background: var(--green-color);
            color: white;
            font-size: 40px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
        }
        #playBtn:active { transform: scale(0.95); }
        #playBtn.paused { background: var(--orange-color); }
        
        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #eee;
            margin-bottom: 25px;
        }
        #speedSlider {
            -webkit-appearance: none;
            appearance: none;
            width: 80%;
            height: 10px;
            background: #555;
            outline: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        #speedSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: white;
            border-radius: 50%;
            border: 3px solid var(--green-color);
        }

        #numberGrid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        .number-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 32px;
            background: linear-gradient(to bottom, #fefefe, #e0e0e0);
            font-weight: bold;
            color: #333;
            border-radius: 5px;
            box-shadow: 0 2px 2px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .number-cell.called {
            background: var(--pink-button);
            color: white;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.25);
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="dialog-overlay" id="restartDialog">
            <div class="dialog-box">
                <h2>ARE YOU SURE YOU WANT<br>TO RE-START THE GAME?</h2>
                <div class="dialog-buttons">
                    <button class="dialog-btn" id="dialog-yes">Yes</button>
                    <button class="dialog-btn" id="dialog-no">No</button>
                </div>
            </div>
        </div>

        <div class="top-bar">
            <div id="soundBtn" class="icon-btn">üîä</div>
            <button id="restartBtn">Restart Game</button>
            <div id="homeBtn" class="icon-btn">üè†</div>
        </div>
        <div class="display-area">
            <div class="token-display">
                <div id="prevTokenBox" class="token-box">0</div>
                <div class="token-label">Prev. Token</div>
            </div>
            <div id="currentTokenBox" class="token-box">0</div>
            <button id="playBtn">‚ñ∂</button>
        </div>
        <div class="slider-container">
            <label id="speedLabel">Delay Speed: 2 Sec</label>
            <input type="range" min="1" max="10" value="2" id="speedSlider">
        </div>
        <div id="numberGrid"></div>
    </div>

    <script>
        const socket = io();
        const restartDialog = document.getElementById('restartDialog');
        const dialogYesBtn = document.getElementById('dialog-yes');
        const dialogNoBtn = document.getElementById('dialog-no');

        const prevTokenEl = document.getElementById('prevTokenBox');
        const currentTokenEl = document.getElementById('currentTokenBox');
        const playBtn = document.getElementById('playBtn');
        const restartBtn = document.getElementById('restartBtn');
        const numberGrid = document.getElementById('numberGrid');
        const speedSlider = document.getElementById('speedSlider');
        const speedLabel = document.getElementById('speedLabel');
        const soundBtn = document.getElementById('soundBtn');
        
        let allNumbers = [];
        let drawnNumbers = [];
        let currentNumber = 0;
        let previousNumber = 0;
        let isPlaying = false;
        let isSoundOn = true;
        let nextDrawTimeout = null;

        let synth = window.speechSynthesis;
        let indianEnglishVoice = null;
        let voicesLoaded = false;
        let hasInteracted = false;

        function numberToWords(num) {
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            if (num === 0) return 'Zero';
            if (num < 10) return ones[num];
            if (num < 20) return teens[num - 10];
            const tenDigit = Math.floor(num / 10);
            const oneDigit = num % 10;
            return oneDigit === 0 ? tens[tenDigit] : tens[tenDigit] + ' ' + ones[oneDigit];
        }

        function formatSpokenText(num) {
            if (num === 0) return "Zero"; 
            const fullWord = numberToWords(num);
            if (num < 10) {
                return `single number ${fullWord}`;
            } else {
                const digits = num.toString().split('');
                const digitWords = digits.map(d => numberToWords(parseInt(d))).join(' ');
                return `${digitWords}, ${fullWord}`;
            }
        }

        function loadVoices() {
            if (voicesLoaded) return Promise.resolve();
            return new Promise(resolve => {
                const checkVoices = () => {
                    const voices = synth.getVoices();
                    if (voices.length > 0) {
                        voicesLoaded = true;
                        indianEnglishVoice = voices.find(voice => voice.lang === 'en-IN' && voice.name.toLowerCase().includes('female'));
                        if (!indianEnglishVoice) indianEnglishVoice = voices.find(voice => voice.lang === 'en-IN');
                        if (!indianEnglishVoice) indianEnglishVoice = voices.find(voice => voice.lang.startsWith('en-'));
                        console.log("Voices loaded. Selected:", indianEnglishVoice ? indianEnglishVoice.name : "Default English");
                        resolve();
                    }
                };
                checkVoices();
                if (synth.onvoiceschanged !== undefined) {
                    synth.onvoiceschanged = checkVoices;
                }
                setTimeout(() => { if (!voicesLoaded) checkVoices(); }, 100);
            });
        }

        function speakText(textToSpeak, onEndCallback) {
            if (!isSoundOn || !synth || !textToSpeak) {
                if (onEndCallback) onEndCallback();
                return;
            }
            synth.cancel(); 
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            if (indianEnglishVoice) {
                utterance.voice = indianEnglishVoice;
            }
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            utterance.onend = onEndCallback;
            utterance.onerror = (event) => {
                console.error('Speech synthesis error:', event);
                if (onEndCallback) onEndCallback();
            };
            synth.speak(utterance);
        }

        function initializeGame() {
            isPlaying = false;
            clearTimeout(nextDrawTimeout);
            if(synth) synth.cancel();
            
            allNumbers = Array.from({ length: 90 }, (_, i) => i + 1);
            drawnNumbers = [];
            currentNumber = 0;
            previousNumber = 0;

            updateDisplay();
            generateGrid();
            
            playBtn.innerHTML = '‚ñ∂';
            playBtn.classList.remove('paused');
            
            socket.emit('game-event', { type: 'restart' });
        }

        function generateGrid() {
            numberGrid.innerHTML = '';
            for (let i = 1; i <= 90; i++) {
                const cell = document.createElement('div');
                cell.classList.add('number-cell');
                cell.textContent = i;
                cell.id = `cell-${i}`;
                numberGrid.appendChild(cell);
            }
        }

        function updateDisplay() {
            currentTokenEl.textContent = String(currentNumber);
            prevTokenEl.textContent = String(previousNumber);
        }

        function callNumber(newNumber, isManualCall = false) {
            if (drawnNumbers.includes(newNumber) || newNumber < 1 || newNumber > 90) {
                return null;
            }
            
            const indexToRemove = allNumbers.indexOf(newNumber);
            if (indexToRemove > -1) {
                allNumbers.splice(indexToRemove, 1);
            }

            previousNumber = currentNumber;
            currentNumber = newNumber;
            drawnNumbers.push(newNumber);
            
            if (!isManualCall) {
                socket.emit('game-event', { type: 'numberDrawn', numbers: JSON.stringify(drawnNumbers) });
            }

            updateDisplay();
            markNumberOnGrid(newNumber);
            
            return formatSpokenText(currentNumber);
        }

        function gameLoop() {
            if (!isPlaying) return;

            if (allNumbers.length === 0) {
                currentTokenEl.textContent = "END";
                speakText("Game Over. Thank you for playing.", null);
                if (isPlaying) togglePlayPause();
                return;
            }

            const randomIndex = Math.floor(Math.random() * allNumbers.length);
            const newNumber = allNumbers[randomIndex];
            
            const textForSpeech = callNumber(newNumber);

            if (textForSpeech) {
                speakText(textForSpeech, () => {
                    if (isPlaying) {
                        nextDrawTimeout = setTimeout(gameLoop, speedSlider.value * 1000);
                    }
                });
            }
        }
        
        function markNumberOnGrid(number) {
            const cell = document.getElementById(`cell-${number}`);
            if (cell) cell.classList.add('called');
        }

        async function togglePlayPause() {
            if (!hasInteracted) {
                hasInteracted = true;
                await loadVoices();
                if (isSoundOn) {
                    const utterance = new SpeechSynthesisUtterance(" ");
                    utterance.volume = 0;
                    synth.speak(utterance);
                }
            }

            isPlaying = !isPlaying;
            socket.emit('game-event', { type: 'gameState', isPlaying: isPlaying });


            if (isPlaying) {
                playBtn.innerHTML = '‚è∏';
                playBtn.classList.add('paused');
                gameLoop();
            } else {
                playBtn.innerHTML = '‚ñ∂';
                playBtn.classList.remove('paused');
                clearTimeout(nextDrawTimeout);
                if(synth) synth.cancel();
            }
        }
        
        // --- EVENT LISTENERS ---
        restartBtn.addEventListener('click', () => {
            restartDialog.classList.add('visible');
        });

        dialogNoBtn.addEventListener('click', () => {
            restartDialog.classList.remove('visible');
        });

        dialogYesBtn.addEventListener('click', () => {
            restartDialog.classList.remove('visible');
            initializeGame();
        });

        playBtn.addEventListener('click', togglePlayPause);
        
        speedSlider.addEventListener('input', (e) => {
            speedLabel.textContent = `Delay Speed: ${e.target.value} Sec`;
        });

        soundBtn.addEventListener('click', () => {
            isSoundOn = !isSoundOn;
            soundBtn.innerHTML = isSoundOn ? 'üîä' : 'üîá';
            soundBtn.style.opacity = isSoundOn ? 1 : 0.6;
            if (!isSoundOn) {
                if(synth) synth.cancel();
            }
        });

        document.getElementById('homeBtn').addEventListener('click', () => {
            alert('Home button functionality can be added here!');
        });
        
        // --- SOCKET.IO LOGIC ---
        socket.on('game-sync', (gameState) => {
            console.log('Syncing game state from server...');
            drawnNumbers = gameState.drawnNumbers || [];
            isPlaying = gameState.isPlaying || false;

            allNumbers = Array.from({ length: 90 }, (_, i) => i + 1).filter(n => !drawnNumbers.includes(n));
            currentNumber = drawnNumbers[drawnNumbers.length - 1] || 0;
            previousNumber = drawnNumbers[drawnNumbers.length - 2] || 0;

            updateDisplay();
            generateGrid();
            drawnNumbers.forEach(n => markNumberOnGrid(n));

            playBtn.innerHTML = isPlaying ? '‚è∏' : '‚ñ∂';
            playBtn.classList.toggle('paused', isPlaying);
        });

        socket.on('game-event', (data) => {
             if (data.type === 'manualNumberCall') {
                console.log('Manual number call received:', data.number);
                const numberToCall = parseInt(data.number);
                if (!isNaN(numberToCall) && !drawnNumbers.includes(numberToCall)) {
                    
                    clearTimeout(nextDrawTimeout);
                    synth.cancel();
                    
                    const wasPlaying = isPlaying;
                    if(wasPlaying) {
                      isPlaying = false; 
                    }

                    const spokenText = callNumber(numberToCall, true); 
                    
                    if(spokenText) {
                         speakText(spokenText, () => {
                            if (wasPlaying) {
                                isPlaying = true;
                                nextDrawTimeout = setTimeout(gameLoop, speedSlider.value * 1000);
                            }
                         });
                    }
                }
            } else if (data.type === 'restart') {
                console.log('Restart event received from server.');
                initializeGame();
            } else if (data.type === 'gameState') {
                // This part is tricky. Avoid re-triggering play/pause if this client was the initiator.
                // For now, we just log it. A more robust solution might use client IDs.
                console.log('Another client changed play state to:', data.isPlaying);
            }
        });

        // --- INITIAL LOAD ---
        window.onload = () => {
            generateGrid();
            socket.emit('connection'); // Request initial state
        };

    </script>
</body>
</html>